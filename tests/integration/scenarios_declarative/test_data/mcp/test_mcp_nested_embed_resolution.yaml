# Test case for recursive embed resolution in nested MCP tool parameters
name: "MCP Nested Embed Resolution Test"
description: "Test that MCP tools can resolve embeds in deeply nested data structures (lists, dicts, tuples)"

setup:
  artifacts:
    - name: "test_content"
      content: "Resolved content from artifact"
      
steps:
  - name: "Test nested embed resolution in complex data structure"
    agent_request:
      message: |
        Use the test_mcp_tool with this complex nested parameter structure:
        {
          "response_to_return": {
            "content": [
              {
                "type": "text", 
                "text": "Math result: «math:5*3» at time «datetime:iso»"
              },
              {
                "type": "artifact",
                "content": "«artifact_content:test_content»"
              }
            ],
            "metadata": {
              "calculations": ["«math:2+2»", "«math:10/2»"],
              "timestamps": {
                "created": "«datetime:iso»",
                "processed": "«datetime:unix»"
              }
            },
            "mixed_types": (
              "Tuple with «math:7+3»",
              ["List in tuple: «math:9-4»", "«artifact_content:test_content»"]
            )
          }
        }
        
        Verify that ALL embeds are resolved at every nesting level.
        
    expected_behavior:
      - All math embeds should be resolved to their calculated values
      - All datetime embeds should be resolved to actual timestamps  
      - All artifact_content embeds should be resolved to "Resolved content from artifact"
      - The nested structure should be preserved exactly
      - No embed syntax (« ») should remain in the final result

validation:
  - type: "response_contains"
    value: "15"  # 5*3 should be resolved
  - type: "response_contains" 
    value: "4"   # 2+2 should be resolved
  - type: "response_contains"
    value: "5"   # 10/2 should be resolved  
  - type: "response_contains"
    value: "10"  # 7+3 should be resolved
  - type: "response_contains"
    value: "5"   # 9-4 should be resolved
  - type: "response_contains"
    value: "Resolved content from artifact"  # artifact_content should be resolved
  - type: "response_not_contains"
    value: "«"   # No embed syntax should remain
  - type: "response_not_contains" 
    value: "»"   # No embed syntax should remain